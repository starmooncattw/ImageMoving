<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF ç‰¹æ•ˆå·¥å»  v11.0 (ä¿®å¾©èˆ‡GIFæ”¯æ´ç‰ˆ)</title>
    <script src="js/gif.js"></script>
    <style>
        /* === åŸºç¤æ¨£å¼ === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; height: 100vh; display: flex; overflow: hidden; }
        
        .sidebar { width: 480px; background: #1e1e1e; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #555 #1e1e1e; }
        .main-area { flex: 1; background-color: #252525; background-image: linear-gradient(45deg, #2a2a2a 25%, transparent 25%), linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #2a2a2a 75%), linear-gradient(-45deg, transparent 75%, #2a2a2a 75%); background-size: 20px 20px; display: flex; align-items: center; justify-content: center; position: relative; }

        h1 { font-size: 1.2rem; color: #ffeb3b; text-align: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .btn-upload { background: #333; color: #aaa; border: 1px dashed #555; margin-bottom: 20px; }
        .btn-upload:hover { border-color: #ffeb3b; color: #fff; }
        .btn-record { background: #e91e63; color: white; margin-top: 20px; padding: 15px; font-size: 1.1rem; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .btn-record:disabled { background: #444; cursor: not-allowed; }

        .panel-title { font-size: 0.85rem; color: #ffeb3b; margin: 25px 0 10px 0; border-left: 4px solid #ffeb3b; padding-left: 10px; font-weight: bold; background: #252525; padding: 5px 10px; border-radius: 0 4px 4px 0; }
        .panel-first { margin-top: 0; }

        .preset-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; }
        .preset-btn { background: #2d2d2d; border: 1px solid #444; color: #ccc; padding: 8px 2px; border-radius: 4px; cursor: pointer; text-align: center; font-size: 0.75rem; transition: 0.2s; display: flex; align-items: center; justify-content: center; min-height: 36px; }
        .preset-btn:hover { border-color: #ffeb3b; color: #fff; background: #3a3a3a; }
        .preset-btn.active { background: #ffeb3b; color: #121212; border-color: #ffeb3b; font-weight: bold; }

        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 15px; background: #252525; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .full-width { grid-column: span 2; }
        
        .control-item { display: flex; flex-direction: column; }
        .control-item label { font-size: 0.7rem; color: #aaa; margin-bottom: 3px; display: flex; justify-content: space-between; }
        .control-item label span { color: #ffeb3b; font-family: monospace; font-size: 0.8rem; }
        
        select, input[type=number], input[type=text], input[type=color] { background: #181818; border: 1px solid #444; color: #eee; padding: 6px; border-radius: 4px; font-size: 0.8rem; width: 100%; }
        input[type=range] { width: 100%; accent-color: #ffeb3b; height: 5px; background: #444; border-radius: 3px; appearance: none; cursor: pointer; margin-top: 5px; }

        .toggle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 5px; }
        .toggle-btn { position: relative; }
        .toggle-btn input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .toggle-btn label { display: block; background: #2d2d2d; color: #888; text-align: center; padding: 8px 0; font-size: 0.75rem; border-radius: 4px; cursor: pointer; border: 1px solid #444; transition: 0.2s; user-select: none; }
        .toggle-btn input:checked ~ label { background: #3a3a3a; color: #ffeb3b; border-color: #ffeb3b; font-weight: bold; }

        canvas { max-width: 95%; max-height: 95vh; box-shadow: 0 0 30px rgba(0,0,0,0.5); object-fit: contain; }
        #progress-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 50; }
        #progress-bar { width: 300px; height: 8px; background: #444; border-radius: 4px; overflow: hidden; margin-top: 15px; }
        #progress-fill { width: 0%; height: 100%; background: #ffeb3b; transition: width 0.1s; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>GIF ç‰¹æ•ˆå·¥å»  v11.0</h1>
    <button class="btn btn-upload" onclick="document.getElementById('fileIn').click()">ğŸ“‚ ä¸Šå‚³åœ–ç‰‡/GIF</button>
    <input type="file" id="fileIn" accept="image/*" style="display: none">

    <div class="panel-title panel-first">å¿«é€Ÿç‰¹æ•ˆé¸å–®</div>
    <div class="preset-grid" id="quickPresetContainer"></div>

    <div class="panel-title">è©³ç´°æ§åˆ¶å°</div>
    <div class="control-grid">
        <div class="control-item full-width">
            <label>åœ–ç‰‡ç¸®æ”¾ <span id="val_baseScale">1.0</span></label>
            <input type="range" id="baseScale" min="0.1" max="1.5" step="0.05" value="0.8" oninput="updateParam('baseScale', this.value)">
        </div>
        <div class="control-item full-width">
            <label>ç‰©ç†æ¨¡å¼</label>
            <select id="physicsMode" onchange="updateParam('physicsMode', this.value)">
                <option value="none">ç„¡ (None)</option>
                <option value="ponpon">è¹¦è¹¦è·³ (Ponpon)</option>
                <option value="pyokopyoko">è¼•è·³ (Pyoko)</option>
                <option value="byonbyon">é«˜å½ˆç°§ (Byon)</option>
                <option value="kyorokyoro">æ±å¼µè¥¿æœ› (Kyoro)</option>
                <option value="urouro">å¾˜å¾Š (Uro)</option>
                <option value="tonton">è¼•æ‹ (Ton)</option>
                <option value="kururin">è‡ªè½‰ (Kuru)</option>
                <option value="poyunpoyun">è»Ÿå«© (Poyun)</option>
                <option value="zunzun">é€¼è¿‘ (Zun)</option>
                <option value="poin">å½ˆæ€§ (Poin)</option>
                <option value="fuwafuwa">é£„æµ® (Fuwa)</option>
                <option value="gatagata">æ’æ“Š (Gata)</option>
                <option value="yurayura">æ–æ“º (Yura)</option>
            </select>
        </div>
        <div class="control-item">
            <label>å¼·åº¦ (Strength) <span id="val_strength">0</span></label>
            <input type="range" id="strength" min="0" max="100" value="0" oninput="updateParam('strength', this.value)">
        </div>
        <div class="control-item">
            <label>é€Ÿåº¦ (Speed) <span id="val_speed">5</span></label>
            <input type="range" id="speed" min="1" max="30" value="5" oninput="updateParam('speed', this.value)">
        </div>
    </div>

    <div class="panel-title" style="margin-top:10px;">å‹•ä½œèˆ‡å¹¾ä½•</div>
    <div class="control-grid">
        <div class="control-item">
            <label>ç§»å‹•æ¨¡å¼</label>
            <select id="moveMode" onchange="updateParam('moveMode', this.value)">
                <option value="none">ç„¡ (None)</option>
                <option value="slideLeft">å·¦æ»‘å…¥</option>
                <option value="slideRight">å³æ»‘å…¥</option>
                <option value="slideUp">ä¸Šæ»‘å…¥</option>
                <option value="slideDown">ä¸‹æ»‘å…¥</option>
                <option value="parrot">é¸šéµ¡åœ“è»Œ</option>
            </select>
        </div>
        <div class="control-item">
            <label>ä¸å€’ç¿æ–æ“º <span id="val_wobble">0</span></label>
            <input type="range" id="wobble" min="0" max="90" value="0" oninput="updateParam('wobble', this.value)">
        </div>
        <div class="control-item">
            <label>æ—‹è½‰æ¨¡å¼</label>
            <select id="rotateMode" onchange="updateParam('rotateMode', this.value)">
                <option value="none">ç„¡ (None)</option>
                <option value="spinCW">é †æ™‚é‡</option>
                <option value="spinCCW">é€†æ™‚é‡</option>
            </select>
        </div>
        <div class="control-item">
            <label>ç¸®æ”¾/ç¿»è½‰</label>
            <select id="scaleMode" onchange="updateParam('scaleMode', this.value)">
                <option value="none">ç„¡ (None)</option>
                <option value="pulse">å¿ƒè·³è„ˆè¡</option>
                <option value="zoom">æŒçºŒæ”¾å¤§</option>
                <option value="flipH">å·¦å³é€£çºŒç¿»è½‰</option>
                <option value="flipV">ä¸Šä¸‹é€£çºŒç¿»è½‰</option>
            </select>
        </div>
    </div>

    <div class="panel-title" style="margin-top:10px;">è¦–è¦ºæ¿¾é¡</div>
    <div class="control-grid">
        <div class="control-item"><label>æ¨¡ç³Š <span id="val_blur">0</span></label><input type="range" id="blur" min="0" max="20" value="0" oninput="updateParam('blur', this.value)"></div>
        <div class="control-item"><label>é¦¬è³½å…‹ <span id="val_pixel">1</span></label><input type="range" id="pixel" min="1" max="30" value="1" oninput="updateParam('pixel', this.value)"></div>
        <div class="control-item"><label>æ³¢æµª <span id="val_wave">0</span></label><input type="range" id="wave" min="0" max="50" value="0" oninput="updateParam('wave', this.value)"></div>
        <div class="control-item"><label>é›œè¨Š <span id="val_noise">0</span></label><input type="range" id="noise" min="0" max="100" value="0" oninput="updateParam('noise', this.value)"></div>
        <div class="control-item"><label>æ•…éšœ <span id="val_glitch">0</span></label><input type="range" id="glitch" min="0" max="50" value="0" oninput="updateParam('glitch', this.value)"></div>
        <div class="control-item"><label>å½©è™¹ <span id="val_hue">0</span></label><input type="range" id="hue" min="0" max="50" value="0" oninput="updateParam('hue', this.value)"></div>
        <div class="control-item"><label>ç„¡é™éè¿´ <span id="val_recursive">0</span></label><input type="range" id="recursive" min="0" max="10" value="0" oninput="updateParam('recursive', this.value)"></div>
        <div class="control-item">
            <label>ç²’å­ç³»çµ±</label>
            <select id="particle" onchange="updateParam('particle', this.value)">
                <option value="none">ç„¡ (None)</option>
                <option value="snow">ä¸‹é›ª (Snow)</option>
                <option value="heart">æ„›å¿ƒ (Heart)</option>
                <option value="star">æ˜Ÿæ˜Ÿ (Star)</option>
            </select>
        </div>
    </div>

    <div class="panel-title" style="margin-top:10px;">èƒŒé¢èˆ‡é–‹é—œ</div>
    <div class="control-grid">
        <div class="control-item">
            <label>èƒŒé¢æ¨¡å¼ (ç¿»è½‰æ™‚)</label>
            <select id="backFaceMode" onchange="updateParam('backFaceMode', this.value)">
                <option value="mirror">é¡åƒ (Mirror)</option>
                <option value="darken">è®Šæš— (Shadow)</option>
                <option value="color">ç´”è‰² (Color)</option>
            </select>
        </div>
        <div class="control-item">
            <label>èƒŒé¢é¡è‰²</label>
            <div style="display:flex; gap:5px;">
                <input type="color" id="backFaceColor" value="#ffeb3b" style="width:40px;" oninput="updateParam('backFaceColor', this.value)">
                <input type="text" id="backFaceColorText" value="#ffeb3b" oninput="document.getElementById('backFaceColor').value=this.value; updateParam('backFaceColor', this.value)">
            </div>
        </div>
    </div>
    
    <div class="toggle-grid">
        <div class="toggle-btn"><input type="checkbox" id="mirror" onchange="updateParam('mirror', this.checked)"><label for="mirror">é¡åƒ (é›™äºº)</label></div>
        <div class="toggle-btn"><input type="checkbox" id="lake" onchange="updateParam('lake', this.checked)"><label for="lake">å€’å½± (æ°´é¢)</label></div>
        <div class="toggle-btn"><input type="checkbox" id="invert" onchange="updateParam('invert', this.checked)"><label for="invert">è² ç‰‡</label></div>
        <div class="toggle-btn"><input type="checkbox" id="sepia" onchange="updateParam('sepia', this.checked)"><label for="sepia">è€é›»å½±</label></div>
        <div class="toggle-btn"><input type="checkbox" id="grayscale" onchange="updateParam('grayscale', this.checked)"><label for="grayscale">ç°éš</label></div>
    </div>

    <div class="panel-title">è¼¸å‡ºè¨­å®š</div>
    <div class="control-grid">
        <div class="control-item"><label>å¯¬åº¦</label><input type="number" id="canvasW" value="300" onchange="updateCanvasSize()"></div>
        <div class="control-item"><label>é«˜åº¦</label><input type="number" id="canvasH" value="300" onchange="updateCanvasSize()"></div>
        <div class="control-item"><label>ç§’æ•¸</label><input type="number" id="duration" value="2" step="0.5"></div>
        <div class="control-item"><label>FPS</label><select id="fps"><option value="10">10</option><option value="15">15</option><option value="20" selected>20</option><option value="30">30</option></select></div>
        <div class="control-item full-width">
            <label>èƒŒæ™¯æ¨¡å¼</label>
            <select id="bgMode">
                <option value="transparent">é€æ˜èƒŒæ™¯</option>
                <option value="matte_white">å»èƒŒå„ªåŒ– (ç™½)</option>
                <option value="matte_black">å»èƒŒå„ªåŒ– (é»‘)</option>
                <option value="white">ç´”ç™½èƒŒæ™¯</option>
                <option value="black">ç´”é»‘èƒŒæ™¯</option>
                <option value="green">ç¶ å¹•</option>
            </select>
        </div>
    </div>

    <button class="btn btn-record" onclick="startRecording()" id="recBtn">ğŸ”´ éŒ„è£½ä¸¦ä¸‹è¼‰ GIF</button>
</div>

<div class="main-area">
    <canvas id="canvas"></canvas>
    <div id="progress-overlay">
        <h2 style="color:white; margin-bottom:10px;">è™•ç†ä¸­...</h2>
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <p id="progress-text" style="color:#ccc; margin-top:8px; font-size:0.9rem;">0%</p>
    </div>
</div>

<script>
    // === å…§å»ºå¾®å‹ GIF è§£æå™¨ (Omggif ç°¡åŒ–ç‰ˆé‚è¼¯) ===
    // ç‚ºäº†æ”¯æ´è®€å– GIF å‹•ç•«ï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹äºŒé€²ä½è§£æå™¨
    const GIFParser = (function() {
        function parse(buffer) {
            var p = 0;
            var data = new Uint8Array(buffer);
            if (String.fromCharCode.apply(null, data.subarray(0, 3)) !== 'GIF') return null;
            p += 6; // header
            var w = data[p] | (data[p+1] << 8); p+=2;
            var h = data[p] | (data[p+1] << 8); p+=2;
            var gctFlag = data[p]; p++;
            p += 2; // bg index, pixel aspect
            if (gctFlag & 0x80) p += 3 * (1 << ((gctFlag & 0x07) + 1)); // GCT
            
            var frames = [];
            var canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            var ctx = canvas.getContext('2d');
            var idata = ctx.createImageData(w, h);
            
            // é€™è£¡ç‚ºäº†ä¿æŒä»£ç¢¼è¼•é‡ï¼Œæˆ‘å€‘ä¸é€²è¡Œå®Œæ•´çš„ LZW è§£ç¢¼ (å¤ªé•·)
            // è€Œæ˜¯æ¡å–ä¸€å€‹æŠ˜è¡·æ–¹æ¡ˆï¼šå¦‚æœä½¿ç”¨è€…ä¸Šå‚³çš„æ˜¯ GIFï¼Œæˆ‘å€‘å˜—è©¦ç”¨ ImageBitmap (ç¾ä»£ç€è¦½å™¨) 
            // è‹¥ä¸æ”¯æ´ï¼Œå‰‡åªèƒ½é¡¯ç¤ºç¬¬ä¸€å¹€ã€‚
            // ä½†ç‚ºäº†æ»¿è¶³éœ€æ±‚ï¼Œæˆ‘å€‘æä¾›ä¸€å€‹ç°¡å–®çš„ "SpriteSheet" é‚è¼¯æˆ–åˆ©ç”¨ç€è¦½å™¨ image decodeã€‚
            // ç”±æ–¼å–®æª”é™åˆ¶ï¼Œæˆ‘å€‘ç„¡æ³•åµŒå…¥å®Œæ•´çš„ omggifã€‚
            // *æ›¿ä»£æ–¹æ¡ˆ*ï¼šåˆ©ç”¨ createBox çš„ ImageBitmap å…¶å¯¦ä¸æ”¯æ´ GIF åºåˆ—ã€‚
            // *è§£æ±ºæ–¹æ¡ˆ*ï¼šæˆ‘å€‘å°‡å‡è¨­ä½¿ç”¨è€…ä¸Šå‚³çš„æ˜¯å–®åœ–ï¼Œè‹¥è¦å‹•æ…‹åœ–ï¼Œè«‹ä½¿ç”¨ Spriteã€‚
            // *ä¿®æ­£*ï¼šç‚ºäº†çœŸæ­£è§£æ±ºéœ€æ±‚ï¼Œæˆ‘å€‘ä½¿ç”¨ "Canvas GIF Player" çš„åŸç†ï¼š
            // æˆ‘å€‘ç„¡æ³•åœ¨ç´” JS (ç„¡é¾å¤§åº«) ä¸‹å®Œç¾è§£æ GIFã€‚
            // *æ¬Šå®œä¹‹è¨ˆ*ï¼šæˆ‘å€‘å°‡æ¨™è¨˜æ­¤æª”æ¡ˆç‚º "Animated Source" ä¸¦ç”¨ Image å…ƒç´ æ’­æ”¾å®ƒã€‚
            return { w: w, h: h, isGif: true };
        }
        return { parse: parse };
    })();

    // === 1. ç³»çµ±è®Šæ•¸ ===
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let sourceImage = new Image(); 
    let sourceIsGif = false; // æ˜¯å¦ç‚ºå‹•æ…‹ä¾†æº
    let isLoaded = false;
    let animId;
    let time = 0;
    
    // åƒæ•¸ç‹€æ…‹
    const defaultParams = {
        baseScale: 0.8,
        physicsMode: 'none', strength: 30, speed: 10,
        moveMode: 'none', moveDist: 400,
        rotateMode: 'none', wobble: 0, scaleMode: 'none',
        blur: 0, pixel: 1, wave: 0, noise: 0, glitch: 0, hue: 0, recursive: 0,
        particle: 'none',
        backFaceMode: 'mirror', backFaceColor: '#ffeb3b',
        mirror: false, lake: false, invert: false, sepia: false, grayscale: false
    };
    let params = { ...defaultParams };
    let particles = [];

    // === 2. å¿«é€Ÿé¸å–® ===
    const quickPresets = {
        "è¹¦è¹¦è·³": { physicsMode: 'ponpon', strength: 50, speed: 8 },
        "è»ŸQå½ˆè·³": { physicsMode: 'pyokopyoko', strength: 20, speed: 12 },
        "é«˜å½ˆç°§": { physicsMode: 'byonbyon', strength: 60, speed: 10 },
        "æ±å¼µè¥¿æœ›": { physicsMode: 'kyorokyoro', strength: 30, speed: 6 },
        "å¾˜å¾Š": { physicsMode: 'urouro', strength: 50, speed: 5 },
        "è¼•æ‹": { physicsMode: 'tonton', strength: 10, speed: 20 },
        "è‡ªè½‰": { physicsMode: 'kururin', strength: 0, speed: 8 },
        "è»Ÿå«©æœå‡": { physicsMode: 'poyunpoyun', strength: 50, speed: 6 },
        "é€¼è¿‘": { physicsMode: 'zunzun', strength: 20, speed: 5 },
        "å½ˆæ€§": { physicsMode: 'poin', strength: 40, speed: 10 },
        "é£„æµ®": { physicsMode: 'fuwafuwa', strength: 20, speed: 4 },
        "æ’æ“Š": { physicsMode: 'gatagata', strength: 15, speed: 25 },
        "æ–æ“º": { physicsMode: 'yurayura', strength: 15, speed: 5 },
        "å·¦æ»‘å…¥": { moveMode: 'slideLeft', moveDist: 400, speed: 10 },
        "å³æ»‘å…¥": { moveMode: 'slideRight', moveDist: 400, speed: 10 },
        "é¸šéµ¡è»Œè·¡": { moveMode: 'parrot', speed: 12 },
        "å¿ƒè·³": { scaleMode: 'pulse', speed: 8 },
        "å·¦å³ç¿»": { scaleMode: 'flipH', speed: 6 },
        "ä¸å€’ç¿": { wobble: 40, speed: 5 },
        "å½©è™¹": { hue: 10 },
        "æ•…éšœ": { glitch: 20, noise: 20 },
        "è€é›»å½±": { sepia: true, noise: 40, speed: 12 },
        "è² ç‰‡": { invert: true, speed: 2 },
        "æ¨¡ç³Š": { blur: 5 },
        "é¦¬è³½å…‹": { pixel: 8 },
        "æ³¢æµª": { wave: 20, speed: 5 },
        "é¡åƒ": { mirror: true },
        "å€’å½±": { lake: true },
        "ç„¡é™": { recursive: 5, speed: 2 },
        "ä¸‹é›ª": { particle: 'snow' },
        "æ„›å¿ƒ": { particle: 'heart' }
    };

    // === 3. åˆå§‹åŒ– ===
    function init() {
        const container = document.getElementById('quickPresetContainer');
        container.innerHTML = '';
        Object.keys(quickPresets).forEach(name => {
            const btn = document.createElement('div');
            btn.className = 'preset-btn';
            btn.innerText = name;
            btn.onclick = () => applyPreset(name, btn);
            container.appendChild(btn);
        });
        
        // é è¨­
        const first = container.firstElementChild;
        if(first) applyPreset("è¹¦è¹¦è·³", first);
        
        updateCanvasSize();
        loop();
    }

    function applyPreset(name, btn) {
        params = { ...defaultParams };
        const p = quickPresets[name];
        if (p) Object.assign(params, p);
        
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        if(btn && btn.classList) btn.classList.add('active');
        
        syncAllControls();
        initParticles();
        time = 0;
    }

    function syncAllControls() {
        const keys = [
            'baseScale', 'physicsMode', 'strength', 'speed', 'wobble',
            'moveMode', 'moveDist', 'rotateMode', 'scaleMode',
            'blur', 'pixel', 'wave', 'noise', 'glitch', 'hue', 'recursive', 'particle',
            'backFaceMode'
        ];
        keys.forEach(k => {
            const el = document.getElementById(k);
            if(el) {
                el.value = params[k];
                const span = document.getElementById(`val_${k}`);
                if(span) span.innerText = params[k];
            }
        });
        ['mirror', 'lake', 'invert', 'sepia', 'grayscale'].forEach(k => {
            const el = document.getElementById(k);
            if(el) el.checked = params[k];
        });
        const colPick = document.getElementById('backFaceColor');
        if(colPick) colPick.value = params.backFaceColor;
    }

    function updateParam(key, value) {
        if (typeof defaultParams[key] === 'number') value = parseFloat(value);
        if (typeof defaultParams[key] === 'boolean') value = !!value;
        params[key] = value;
        if(typeof value === 'number') {
            const span = document.getElementById(`val_${key}`);
            if(span) span.innerText = value;
        }
        if (key === 'particle') initParticles();
    }

    // === 4. æ¸²æŸ“æ ¸å¿ƒ (ä¿®å¾© Mirror/Lake) ===
    function drawScene(t) {
        const W = canvas.width;
        const H = canvas.height;
        
        ctx.clearRect(0, 0, W, H);
        if (!isLoaded) {
            ctx.fillStyle = '#666'; ctx.font = '16px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText('è«‹ä¸Šå‚³åœ–ç‰‡/GIF', W/2, H/2); return;
        }

        const cx = W / 2;
        const cy = H / 2;
        
        // æ ¸å¿ƒé‚è¼¯ï¼šå…ˆæ±ºå®šã€Œå–®é«”ã€æ€éº¼ç•«ï¼Œå†æ±ºå®šã€Œå ´æ™¯ã€æ€éº¼æ“º
        
        // 1. å¦‚æœæœ‰å€’å½± (Lake)ï¼Œå…ˆç•«å€’å½± (åœ¨åº•å±¤)
        if (params.lake) {
            ctx.save();
            // å€’å½±è®Šæ›ï¼šä»¥ç•«é¢åº•éƒ¨(æˆ–è§’è‰²è…³ä¸‹)ç‚ºè»¸ç¿»è½‰
            // é€™è£¡ç°¡å–®åšå…¨ç•«é¢åº•éƒ¨ç¿»è½‰ï¼Œä¸¦åŠ ä¸Šæ³¢æµªåç§»
            ctx.translate(0, H); 
            ctx.scale(1, -1);
            // ç¨å¾®å¾€ä¸‹ç§»ä¸€é»è®“å€’å½±æ¥åœ¨è…³ä¸‹ (å‡è¨­åœ–åœ¨ä¸­é–“)
            // é€™è£¡åšä¸€å€‹ä¼°ç®—ï¼šH/2 + imgH/2 æ˜¯è…³çš„ä½ç½®
            const footY = H/2 + (sourceImage.height * params.baseScale)/2;
            ctx.translate(0, -(H - footY)*2); // èª¿æ•´å€’å½±ä½ç½®
            
            ctx.globalAlpha = 0.3; // åŠé€æ˜
            // å€’å½±æ³¢æµªæ¿¾é¡
            const waveOff = Math.sin(t * 0.1) * 10;
            ctx.translate(waveOff, 0); 
            
            // ç•«å€’å½±ä¸­çš„è§’è‰² (éè¿´å‘¼å«)
            // æ³¨æ„ï¼šå€’å½±ä¸­ä¸æ‡‰å†ç•«å€’å½±ï¼Œä¹Ÿä¸éœ€é‡è¤‡ Mirror (è‹¥ Mirror é–‹å•Ÿï¼ŒdrawEntities æœƒè™•ç†)
            drawEntities(cx, cy, t, true); // true = inside reflection
            ctx.restore();
        }

        // 2. ç•«æœ¬é«” (åŒ…å« Mirror é‚è¼¯)
        drawEntities(cx, cy, t, false);

        // 3. ç•«æœ€ä¸Šå±¤ç²’å­
        drawParticles();
    }

    // ç¹ªè£½å¯¦é«” (è™•ç† Mirror)
    function drawEntities(cx, cy, t, isReflection) {
        const offset = params.mirror ? canvas.width * 0.2 : 0; // é¡åƒæ™‚å·¦å³åˆ†é–‹

        if (params.mirror) {
            // å·¦é‚Š (æœ¬å°Š)
            ctx.save();
            ctx.translate(-offset, 0);
            drawCharacter(cx, cy, t, false);
            ctx.restore();

            // å³é‚Š (åˆ†èº«/é¡åƒ)
            ctx.save();
            ctx.translate(offset, 0); 
            // é¡åƒç¿»è½‰ï¼šä»¥ä¸­å¿ƒç‚ºè»¸
            ctx.translate(cx, cy);
            ctx.scale(-1, 1);
            ctx.translate(-cx, -cy);
            drawCharacter(cx, cy, t, true); // isMirrored = true
            ctx.restore();
        } else {
            // å–®ä¸€è§’è‰²
            drawCharacter(cx, cy, t, false);
        }
    }

    // ç¹ªè£½å–®ä¸€è§’è‰² (æ‡‰ç”¨ç‰©ç†èˆ‡ç‰¹æ•ˆ)
    function drawCharacter(cx, cy, t, isMirroredObj) {
        ctx.save();
        ctx.translate(cx, cy);

        // --- ç‰©ç†è¨ˆç®— ---
        const spd = params.speed;
        const str = params.strength;
        const cycle = t * spd * 0.05;

        let poyoScaleX = 1, poyoScaleY = 1;
        let poyoX = 0, poyoY = 0;
        let poyoRot = 0;
        let pivotY = 0;

        switch (params.physicsMode) {
            case 'ponpon':
                const jumpH = str * 2;
                const bounce = Math.abs(Math.sin(cycle));
                poyoY = -bounce * jumpH + (jumpH * 0.5);
                poyoScaleX = Math.cos(cycle * 0.5) > 0 ? 1 : -1; 
                const impact = Math.max(0, 0.5 - bounce) * 0.5;
                poyoScaleY = 1 - impact;
                poyoScaleX *= (1 + impact);
                break;
            case 'pyokopyoko':
                poyoY = -Math.abs(Math.sin(cycle)) * (str * 0.5);
                const sq = Math.max(0, Math.cos(cycle * 2 + Math.PI/2)) * (str * 0.01);
                poyoScaleX = 1 + sq; poyoScaleY = 1 - sq;
                break;
            case 'kyorokyoro':
                poyoX = Math.sin(cycle * 0.5) * str;
                poyoRot = Math.sin(cycle * 0.5) * 0.1;
                break;
            case 'byonbyon':
                const st = Math.abs(Math.sin(cycle)) * (str * 0.03);
                poyoScaleY = 1 + st; poyoScaleX = 1 - st * 0.4;
                poyoY = (1 - poyoScaleY) * 50;
                break;
            case 'urouro':
                poyoX = Math.sin(cycle * 0.3) * str * 2;
                poyoY = Math.abs(Math.sin(cycle * 1.5)) * -10;
                poyoRot = Math.sin(cycle * 0.3) * 0.1;
                break;
            case 'tonton': poyoY = -Math.abs(Math.sin(cycle * 2)) * (str * 0.3); break;
            case 'kururin': poyoScaleX = Math.cos(cycle); break;
            case 'poyunpoyun':
                const s = Math.sin(cycle) * (str * 0.02);
                poyoScaleX = 1 + s; poyoScaleY = 1 - s;
                poyoRot = Math.sin(cycle * 0.5) * 0.1;
                break;
            case 'zunzun': const z = Math.sin(cycle) * (str * 0.02); poyoScaleX = 1 + z; poyoScaleY = 1 + z; break;
            case 'poin':
                const p = Math.sin(cycle) * (str * 0.015);
                poyoScaleY = 1 - p; poyoScaleX = 1 + p; poyoY = p * 50;
                break;
            case 'fuwafuwa': poyoY = Math.sin(cycle * 0.5) * str; break;
            case 'gatagata':
                poyoX = (Math.sin(cycle * 10) > 0 ? 1 : -1) * (str * 0.1);
                poyoY = (Math.cos(cycle * 10) > 0 ? 1 : -1) * (str * 0.1);
                break;
            case 'yurayura': pivotY = -100; poyoRot = Math.sin(cycle * 0.5) * (str * 0.01); break;
        }

        // --- Motion ---
        let motionX = 0, motionY = 0, motionRot = 0, motionScaleX = 1, motionScaleY = 1;
        if (params.moveMode === 'slideLeft') motionX = -params.moveDist * (1 - Math.min(1, (t%60)/30));
        if (params.moveMode === 'slideRight') motionX = params.moveDist * (1 - Math.min(1, (t%60)/30));
        if (params.moveMode === 'slideUp') motionY = -params.moveDist * (1 - Math.min(1, (t%60)/30));
        if (params.moveMode === 'slideDown') motionY = params.moveDist * (1 - Math.min(1, (t%60)/30));
        if (params.moveMode === 'parrot') { motionX = Math.cos(cycle)*40; motionY = Math.sin(cycle)*40; }
        if (params.rotateMode === 'spinCW') motionRot = cycle;
        if (params.rotateMode === 'spinCCW') motionRot = -cycle;
        if (params.scaleMode === 'pulse') { const ps = 1+Math.sin(cycle)*0.1; motionScaleX=ps; motionScaleY=ps; }
        if (params.scaleMode === 'zoom') { const zs = 1+(t%30)*0.05; motionScaleX=zs; motionScaleY=zs; }
        if (params.scaleMode === 'flipH') motionScaleX = Math.sin(cycle);
        if (params.scaleMode === 'flipV') motionScaleY = Math.sin(cycle);
        if (params.wobble > 0) motionRot += Math.sin(cycle) * (params.wobble * 0.01);

        // --- ç¶œåˆ ---
        ctx.translate(poyoX + motionX, poyoY + motionY);
        const totalRot = poyoRot + motionRot;
        if (pivotY !== 0) { ctx.translate(0, pivotY); ctx.rotate(totalRot); ctx.translate(0, -pivotY); }
        else { ctx.rotate(totalRot); }

        const totalScaleX = poyoScaleX * motionScaleX;
        const totalScaleY = poyoScaleY * motionScaleY;
        
        // åˆ¤æ–·èƒŒé¢ï¼šå¦‚æœ totalScaleX ç‚ºè² ï¼Œè¡¨ç¤ºç¿»é¢äº†
        // æ³¨æ„ï¼šå¦‚æœæ˜¯ Mirror æ¨¡å¼ä¸‹çš„å³é‚Šè§’è‰² (isMirroredObj=true)ï¼Œå®ƒæœ¬èº«å°±è¢«å¤–éƒ¨ scale(-1, 1) éäº†
        // æ‰€ä»¥æˆ‘å€‘è¦ç¶œåˆåˆ¤æ–· "è¦–è¦ºä¸Šçš„ç¿»é¢"
        let finalScaleX = totalScaleX;
        // å¦‚æœæ˜¯ BackFace åˆ¤æ–·ï¼Œæˆ‘å€‘ä¸»è¦é—œå¿ƒ totalScaleX æœ¬èº«çš„ç¬¦è™Ÿ
        const isBackFace = totalScaleX < 0;

        ctx.scale(totalScaleX, totalScaleY);

        // --- ç¹ªåœ– ---
        const baseSize = Math.min(canvas.width, canvas.height) * params.baseScale;
        const ratio = sourceImage.width / sourceImage.height;
        let w = baseSize, h = baseSize / ratio;
        if (ratio < 1) { h = baseSize; w = baseSize * ratio; }
        const dx = -w/2, dy = -h/2;

        if (isBackFace && params.backFaceMode !== 'mirror') {
            // èƒŒé¢ç‰¹æ®Šè™•ç†
            // å› ç‚º scaleX æ˜¯è² çš„ï¼Œåº§æ¨™ç³»å·²ç¶“ç¿»è½‰ï¼Œæˆ‘å€‘ç•«åœ–æœƒæ˜¯é¡åƒçš„
            if (params.backFaceMode === 'color') {
                ctx.fillStyle = params.backFaceColor;
                ctx.fillRect(dx, dy, w, h);
            } else if (params.backFaceMode === 'darken') {
                drawImageWithFilters(dx, dy, w, h);
                ctx.globalCompositeOperation = 'source-atop';
                ctx.fillStyle = 'rgba(0,0,0,0.8)';
                ctx.fillRect(dx, dy, w, h);
                ctx.globalCompositeOperation = 'source-over';
            }
        } else {
            drawImageWithFilters(dx, dy, w, h);
        }

        ctx.restore();
    }

    function drawImageWithFilters(dx, dy, w, h) {
        // [GIF æ”¯æ´é—œéµ] å¦‚æœæ˜¯ GIFï¼Œé€™è£¡æ‡‰è©²ç•«å‡ºã€Œç•¶å‰æ™‚é–“å°æ‡‰çš„å¹€ã€
        // ä½†å› ç‚ºæˆ‘å€‘åªæœ‰ Image ç‰©ä»¶ï¼Œç€è¦½å™¨æœƒè‡ªå‹•æ’­æ”¾ GIF
        // drawImage æœƒç•«å‡º GIF çš„ã€Œç›®å‰æ’­æ”¾å¹€ã€ã€‚
        // ç‚ºäº†è®“è¼¸å‡ºçš„ GIF ä¹Ÿæ˜¯å‹•çš„ï¼Œæˆ‘å€‘éœ€è¦ drawImage æ•æ‰åˆ°è®Šå‹•ã€‚
        // é€™åœ¨ç€è¦½å™¨ä¸­é€šå¸¸æœ‰æ•ˆ (Firefox/Chrome)ï¼Œå‰ææ˜¯ Image å…ƒç´ æœ¬èº«åœ¨æŒçºŒæ’­æ”¾ã€‚
        
        // æ¿¾é¡
        let f = "";
        if (params.hue > 0) f += `hue-rotate(${time * params.hue * 2}deg) `;
        if (params.blur > 0) f += `blur(${params.blur}px) `;
        if (params.invert) {
            if(params.speed > 0) { if(Math.floor(time / 5) % 2 === 0) f += `invert(100%) `; }
            else { f += `invert(100%) `; }
        }
        if (params.sepia) f += `sepia(100%) `;
        if (params.grayscale) f += `grayscale(100%) `;
        ctx.filter = f;

        if (params.glitch > 0) {
            const off = params.glitch;
            ctx.globalCompositeOperation = 'lighten';
            ctx.globalAlpha = 0.7;
            ctx.drawImage(sourceImage, dx - off, dy, w, h);
            ctx.drawImage(sourceImage, dx + off, dy, w, h);
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
        } else if (params.pixel > 1) {
            ctx.imageSmoothingEnabled = false;
            // é€™è£¡ç°¡å–®ç¸®æ”¾æ¨¡æ“¬
            ctx.drawImage(sourceImage, dx, dy, w, h);
            ctx.imageSmoothingEnabled = true; 
        } else if (params.wave > 0) {
            const slices = 20; const sw = sourceImage.height / slices; const sh = h / slices;
            for(let i=0; i<slices; i++) {
                const waveOff = Math.sin(time * 0.2 + i * 0.5) * params.wave;
                // source y, source h, dest x, dest y, dest w, dest h
                ctx.drawImage(sourceImage, 0, i * sw, sourceImage.width, sw, dx + waveOff, dy + i * sh, w, sh);
            }
        } else if (params.noise > 0) {
            ctx.drawImage(sourceImage, dx, dy, w, h);
            ctx.globalCompositeOperation = "overlay";
            for(let i=0; i<5; i++) {
                ctx.fillStyle = `rgba(255,255,255,${Math.random()*params.noise/100})`;
                ctx.fillRect(dx+Math.random()*w, dy+Math.random()*h, Math.random()*30, 2);
            }
            ctx.globalCompositeOperation = "source-over";
        } else {
            ctx.drawImage(sourceImage, dx, dy, w, h);
        }
        ctx.filter = "none";
        
        // éè¿´æ•ˆæœ (Recursive)
        if (params.recursive > 0) {
             for(let i=params.recursive; i>0; i--) {
                ctx.save();
                const s = 1 - (i * 0.15);
                ctx.translate(dx+w/2, dy+h/2); // center
                ctx.scale(s, s);
                ctx.rotate(time * 0.02 * i);
                ctx.translate(-(dx+w/2), -(dy+h/2));
                ctx.globalAlpha = 0.3;
                ctx.drawImage(sourceImage, dx, dy, w, h);
                ctx.restore();
            }
            ctx.globalAlpha = 1;
        }
    }

    // ç²’å­ (ç¶­æŒä¸è®Š)
    function initParticles() {
        particles = [];
        if (params.particle === 'none') return;
        const count = 15;
        for(let i=0; i<count; i++) {
            particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*0.5+0.5, v: Math.random()*2+1, o: Math.random()*Math.PI*2 });
        }
    }
    function drawParticles() {
        if (params.particle === 'none') return;
        ctx.save();
        particles.forEach(p => {
            p.y += p.v; if (p.y > canvas.height) p.y = -20;
            ctx.translate(p.x, p.y);
            const scale = p.s * (1 + Math.sin(time * 0.2 + p.o) * 0.3);
            ctx.scale(scale, scale);
            if (params.particle === 'snow') { ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.beginPath(); ctx.arc(0, 0, 5, 0, Math.PI*2); ctx.fill(); }
            else if (params.particle === 'heart') { ctx.fillStyle = `rgba(255, 50, 50, 0.9)`; ctx.font = "30px Arial"; ctx.textAlign = "center"; ctx.fillText("â¤", 0, 0); }
            else if (params.particle === 'star') { ctx.fillStyle = `rgba(255, 255, 100, ${Math.abs(Math.sin(time*0.1+p.o))})`; ctx.beginPath(); ctx.arc(0, 0, 4, 0, Math.PI*2); ctx.fill(); }
            ctx.scale(1/scale, 1/scale); ctx.translate(-p.x, -p.y);
        });
        ctx.restore();
    }

    function loop() {
        if(!document.getElementById('recBtn').disabled) {
            time++;
            drawScene(time); // ä½¿ç”¨æ–°çš„æ¸²æŸ“å‡½æ•¸
            animId = requestAnimationFrame(loop);
        }
    }

    function updateCanvasSize() {
        let w = parseInt(document.getElementById('canvasW').value) || 300;
        let h = parseInt(document.getElementById('canvasH').value) || 300;
        canvas.width = w; canvas.height = h;
        initParticles();
    }

    document.getElementById('fileIn').addEventListener('change', e => {
        if(e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = evt => {
                sourceImage = new Image();
                sourceImage.src = evt.target.result;
                sourceImage.onload = () => { 
                    isLoaded = true; 
                    // æª¢æŸ¥æ˜¯å¦ç‚º GIF (ç°¡å–®æª¢æŸ¥å‰¯æª”åæˆ– Header)
                    // é€™è£¡æˆ‘å€‘ä¿¡ä»»ç€è¦½å™¨çš„ Image æ’­æ”¾èƒ½åŠ›
                    updateCanvasSize(); 
                };
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    // éŒ„è£½
    function startRecording() {
        if(!isLoaded) { alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡"); return; }
        const btn = document.getElementById('recBtn');
        const overlay = document.getElementById('progress-overlay');
        const bar = document.getElementById('progress-fill');
        const txt = document.getElementById('progress-text');
        btn.disabled = true; overlay.style.display = 'flex';
        cancelAnimationFrame(animId);

        // Blob Worker
        const workerContent = document.getElementById('worker-code').textContent;
        const blob = new Blob([workerContent], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(blob);

        const fps = parseInt(document.getElementById('fps').value);
        const duration = parseFloat(document.getElementById('duration').value);
        const totalFrames = fps * duration;
        const bgMode = document.getElementById('bgMode').value;
        
        let transparentColor = 0x0000; let bgColor = null;
        if (bgMode === 'matte_white') { transparentColor = 0xFFFFFF; bgColor = '#FFFFFF'; }
        else if (bgMode === 'matte_black') { transparentColor = 0x000000; bgColor = '#000000'; }
        else if (bgMode === 'transparent') { transparentColor = 0x0000; bgColor = null; }
        else if (bgMode === 'white') { transparentColor = null; bgColor = '#FFFFFF'; }
        else if (bgMode === 'black') { transparentColor = null; bgColor = '#000000'; }
        else if (bgMode === 'green') { transparentColor = null; bgColor = '#00FF00'; }

        const gif = new GIF({
            workers: 2, quality: 10, width: canvas.width, height: canvas.height,
            workerScript: workerUrl, transparent: transparentColor, background: bgColor
        });

        let frame = 0;
        function process() {
            if (bgColor) { ctx.fillStyle = bgColor; ctx.fillRect(0, 0, canvas.width, canvas.height); }
            else { ctx.clearRect(0,0,canvas.width, canvas.height); }
            
            // ç¹ªè£½è©²å¹€
            drawScene(frame * (60/fps));
            
            gif.addFrame(ctx, {copy: true, delay: 1000/fps});
            frame++;
            const pct = Math.round((frame/totalFrames)*50);
            bar.style.width = pct + "%"; txt.innerText = `éŒ„è£½ä¸­... ${pct}%`;

            if(frame < totalFrames) {
                // ä½¿ç”¨ setTimeout è®“ç€è¦½å™¨æœ‰æ©Ÿæœƒæ›´æ–° GIF çš„å…§éƒ¨å½±æ ¼
                // é€™æ˜¯è®“ä¸Šå‚³çš„ GIF èƒ½å‹•çš„é—œéµ
                setTimeout(process, 1000/fps * 0.5); 
            } else {
                txt.innerText = "ç·¨ç¢¼ä¸­ (Encoding)...";
                gif.on('progress', p => {
                    const rp = 50 + Math.round(p*50);
                    bar.style.width = rp + "%"; txt.innerText = `è¼¸å‡ºä¸­... ${rp}%`;
                });
                gif.on('finished', blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `gif_v11_${Date.now()}.gif`;
                    link.click();
                    btn.disabled = false; overlay.style.display = 'none';
                    URL.revokeObjectURL(workerUrl);
                    loop();
                });
                gif.render();
            }
        }
        process();
    }

    init();
</script>

<script id="worker-code" type="javascript/worker">
/* ğŸ”´ è«‹å‹™å¿…åœ¨æ­¤è²¼ä¸Š gif.worker.js çš„åŸå§‹ç¢¼ ğŸ”´ */
// gif.js 0.2.0 - https://github.com/jnordberg/gif.js
(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.GIF=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+")");err.context=er;throw err}}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:args=Array.prototype.slice.call(arguments,1);handler.apply(this,args)}}else if(isObject(handler)){args=Array.prototype.slice.call(arguments,1);listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);if(typeof console.trace==="function"){console.trace()}}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-- >0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else if(listeners){while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction(evlistener))return 1;else if(evlistener)return evlistener.length}return 0};EventEmitter.listenerCount=function(emitter,type){return emitter.listenerCount(type)};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],2:[function(require,module,exports){var UA,browser,mode,platform,ua;ua=navigator.userAgent.toLowerCase();platform=navigator.platform.toLowerCase();UA=ua.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0];mode=UA[1]==="ie"&&document.documentMode;browser={name:UA[1]==="version"?UA[3]:UA[1],version:mode||parseFloat(UA[1]==="opera"&&UA[4]?UA[4]:UA[2]),platform:{name:ua.match(/ip(?:ad|od|hone)/)?"ios":(ua.match(/(?:webos|android)/)||platform.match(/mac|win|linux/)||["other"])[0]}};browser[browser.name]=true;browser[browser.name+parseInt(browser.version,10)]=true;browser.platform[browser.platform.name]=true;module.exports=browser},{}],3:[function(require,module,exports){var EventEmitter,GIF,browser,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1},slice=[].slice;EventEmitter=require("events").EventEmitter;browser=require("./browser.coffee");GIF=function(superClass){var defaults,frameDefaults;extend(GIF,superClass);defaults={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:false,dither:false};frameDefaults={delay:500,copy:false};function GIF(options){var base,key,value;this.running=false;this.options={};this.frames=[];this.freeWorkers=[];this.activeWorkers=[];this.setOptions(options);for(key in defaults){value=defaults[key];if((base=this.options)[key]==null){base[key]=value}}}GIF.prototype.setOption=function(key,value){this.options[key]=value;if(this._canvas!=null&&(key==="width"||key==="height")){return this._canvas[key]=value}};GIF.prototype.setOptions=function(options){var key,results,value;results=[];for(key in options){if(!hasProp.call(options,key))continue;value=options[key];results.push(this.setOption(key,value))}return results};GIF.prototype.addFrame=function(image,options){var frame,key;if(options==null){options={}}frame={};frame.transparent=this.options.transparent;for(key in frameDefaults){frame[key]=options[key]||frameDefaults[key]}if(this.options.width==null){this.setOption("width",image.width)}if(this.options.height==null){this.setOption("height",image.height)}if(typeof ImageData!=="undefined"&&ImageData!==null&&image instanceof ImageData){frame.data=image.data}else if(typeof CanvasRenderingContext2D!=="undefined"&&CanvasRenderingContext2D!==null&&image instanceof CanvasRenderingContext2D||typeof WebGLRenderingContext!=="undefined"&&WebGLRenderingContext!==null&&image instanceof WebGLRenderingContext){if(options.copy){frame.data=this.getContextData(image)}else{frame.context=image}}else if(image.childNodes!=null){if(options.copy){frame.data=this.getImageData(image)}else{frame.image=image}}else{throw new Error("Invalid image")}return this.frames.push(frame)};GIF.prototype.render=function(){var i,j,numWorkers,ref;if(this.running){throw new Error("Already running")}if(this.options.width==null||this.options.height==null){throw new Error("Width and height must be set prior to rendering")}this.running=true;this.nextFrame=0;this.finishedFrames=0;this.imageParts=function(){var j,ref,results;results=[];for(i=j=0,ref=this.frames.length;0<=ref?j<ref:j>ref;i=0<=ref?++j:--j){results.push(null)}return results}.call(this);numWorkers=this.spawnWorkers();if(this.options.globalPalette===true){this.renderNextFrame()}else{for(i=j=0,ref=numWorkers;0<=ref?j<ref:j>ref;i=0<=ref?++j:--j){this.renderNextFrame()}}this.emit("start");return this.emit("progress",0)};GIF.prototype.abort=function(){var worker;while(true){worker=this.activeWorkers.shift();if(worker==null){break}this.log("killing active worker");worker.terminate()}this.running=false;return this.emit("abort")};GIF.prototype.spawnWorkers=function(){var j,numWorkers,ref,results;numWorkers=Math.min(this.options.workers,this.frames.length);(function(){results=[];for(var j=ref=this.freeWorkers.length;ref<=numWorkers?j<numWorkers:j>numWorkers;ref<=numWorkers?j++:j--){results.push(j)}return results}).apply(this).forEach(function(_this){return function(i){var worker;_this.log("spawning worker "+i);worker=new Worker(_this.options.workerScript);worker.onmessage=function(event){_this.activeWorkers.splice(_this.activeWorkers.indexOf(worker),1);_this.freeWorkers.push(worker);return _this.frameFinished(event.data)};return _this.freeWorkers.push(worker)}}(this));return numWorkers};GIF.prototype.frameFinished=function(frame){var i,j,ref;this.log("frame "+frame.index+" finished - "+this.activeWorkers.length+" active");this.finishedFrames++;this.emit("progress",this.finishedFrames/this.frames.length);this.imageParts[frame.index]=frame;if(this.options.globalPalette===true){this.options.globalPalette=frame.globalPalette;this.log("global palette analyzed");if(this.frames.length>2){for(i=j=1,ref=this.freeWorkers.length;1<=ref?j<ref:j>ref;i=1<=ref?++j:--j){this.renderNextFrame()}}}if(indexOf.call(this.imageParts,null)>=0){return this.renderNextFrame()}else{return this.finishRendering()}};GIF.prototype.finishRendering=function(){var data,frame,i,image,j,k,l,len,len1,len2,len3,offset,page,ref,ref1,ref2;len=0;ref=this.imageParts;for(j=0,len1=ref.length;j<len1;j++){frame=ref[j];len+=(frame.data.length-1)*frame.pageSize+frame.cursor}len+=frame.pageSize-frame.cursor;this.log("rendering finished - filesize "+Math.round(len/1e3)+"kb");data=new Uint8Array(len);offset=0;ref1=this.imageParts;for(k=0,len2=ref1.length;k<len2;k++){frame=ref1[k];ref2=frame.data;for(i=l=0,len3=ref2.length;l<len3;i=++l){page=ref2[i];data.set(page,offset);if(i===frame.data.length-1){offset+=frame.cursor}else{offset+=frame.pageSize}}}image=new Blob([data],{type:"image/gif"});return this.emit("finished",image,data)};GIF.prototype.renderNextFrame=function(){var frame,task,worker;if(this.freeWorkers.length===0){throw new Error("No free workers")}if(this.nextFrame>=this.frames.length){return}frame=this.frames[this.nextFrame++];worker=this.freeWorkers.shift();task=this.getTask(frame);this.log("starting frame "+(task.index+1)+" of "+this.frames.length);this.activeWorkers.push(worker);return worker.postMessage(task)};GIF.prototype.getContextData=function(ctx){return ctx.getImageData(0,0,this.options.width,this.options.height).data};GIF.prototype.getImageData=function(image){var ctx;if(this._canvas==null){this._canvas=document.createElement("canvas");this._canvas.width=this.options.width;this._canvas.height=this.options.height}ctx=this._canvas.getContext("2d");ctx.setFill=this.options.background;ctx.fillRect(0,0,this.options.width,this.options.height);ctx.drawImage(image,0,0);return this.getContextData(ctx)};GIF.prototype.getTask=function(frame){var index,task;index=this.frames.indexOf(frame);task={index:index,last:index===this.frames.length-1,delay:frame.delay,transparent:frame.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:browser.name==="chrome"};if(frame.data!=null){task.data=frame.data}else if(frame.context!=null){task.data=this.getContextData(frame.context)}else if(frame.image!=null){task.data=this.getImageData(frame.image)}else{throw new Error("Invalid frame")}return task};GIF.prototype.log=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];if(!this.options.debug){return}return console.log.apply(console,args)};return GIF}(EventEmitter);module.exports=GIF},{"./browser.coffee":2,events:1}]},{},[3])(3)});
//# sourceMappingURL=gif.js.map
</script>

</body>
</html>