<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡å‹•ç•«è¨­å®šå·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .section { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .section h2 { font-size: 18px; margin-bottom: 15px; color: #667eea; cursor: pointer; user-select: none; }
        .section h2::before { content: 'â–¼ '; font-size: 12px; }
        .section.collapsed h2::before { content: 'â–¶ '; }
        .section.collapsed .content { display: none; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="file"], input[type="number"], input[type="color"], select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        input[type="range"] { width: 100%; }
        .range-label { display: flex; justify-content: space-between; font-size: 12px; color: #888; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .checkbox-group input[type="checkbox"] { width: auto; }
        .effect-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 2px solid #e0e0e0; }
        .effect-item.enabled { border-color: #667eea; }
        .effect-controls { margin-top: 10px; display: none; }
        .effect-item.enabled .effect-controls { display: block; }
        .preview { width: 200px; height: 200px; border: 2px dashed #ddd; margin: 10px auto; display: flex; align-items: center; justify-content: center; background: #f0f0f0; position: relative; overflow: hidden; }
        .preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .radio-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .radio-group label { font-weight: normal; display: flex; align-items: center; gap: 5px; }
        .template-btn { padding: 8px 15px; margin: 5px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 5px; cursor: pointer; }
        .template-btn:hover { background: #667eea; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ åœ–ç‰‡å‹•ç•«è¨­å®šå·¥å…·</h1>

        <!-- åŸºç¤è¨­å®š -->
        <div class="section">
            <h2>åŸºç¤è¨­å®š</h2>
            <div class="content">
                <div class="form-group">
                    <label>åœ–ç‰‡ä¸Šå‚³ (JPG/PNG/GIF/WebP)</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <div class="preview" id="preview">
                    <span style="color: #999;">é è¦½å€</span>
                </div>
            </div>
        </div>

        <!-- é è¨­ç¯„æœ¬ -->
        <div class="section">
            <h2>å¿«é€Ÿç¯„æœ¬</h2>
            <div class="content">
                <button class="template-btn" onclick="loadTemplate('pet')">æ¡Œé¢å¯µç‰©</button>
                <button class="template-btn" onclick="loadTemplate('float')">é£„æµ®æ•ˆæœ</button>
                <button class="template-btn" onclick="loadTemplate('neon')">éœ“è™¹ç‡ˆ</button>
                <button class="template-btn" onclick="loadTemplate('roll')">ç¿»æ»¾å‹•ç•«</button>
                <button class="template-btn" onclick="loadTemplate('randomPop')">éš¨æ©Ÿå‡ºç¾</button>
            </div>
        </div>

        <!-- ç§»å‹•è¨­å®š -->
        <div class="section">
            <h2>ç§»å‹•è¨­å®š</h2>
            <div class="content">
                <div class="form-group">
                    <label>ç§»å‹•æ¨¡å¼</label>
                    <select id="moveMode">
                        <option value="static">éœæ­¢</option>
                        <option value="randomAppear">éš¨æ©Ÿå‡ºç¾</option>
                        <option value="randomBounce">å½ˆè·³ç§»å‹•</option>
                        <option value="leftToRight">æ°´å¹³: å·¦â†’å³</option>
                        <option value="rightToLeft">æ°´å¹³: å³â†’å·¦</option>
                        <option value="horizontalLoop">æ°´å¹³: ä¾†å›</option>
                        <option value="topToBottom">å‚ç›´: ä¸Šâ†’ä¸‹</option>
                        <option value="bottomToTop">å‚ç›´: ä¸‹â†’ä¸Š</option>
                        <option value="verticalLoop">å‚ç›´: ä¾†å›</option>
                        <option value="diagonalTLBR">å°è§’ç·š: å·¦ä¸Šâ†’å³ä¸‹</option>
                        <option value="diagonalTRBL">å°è§’ç·š: å³ä¸Šâ†’å·¦ä¸‹</option>
                        <option value="diagonalBLTR">å°è§’ç·š: å·¦ä¸‹â†’å³ä¸Š</option>
                        <option value="diagonalBRTL">å°è§’ç·š: å³ä¸‹â†’å·¦ä¸Š</option>
                        <option value="circle">åœ“å‘¨é‹å‹•</option>
                        <option value="zigzag">ä¹‹å­—å½¢</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é€Ÿåº¦</label>
                    <input type="range" id="speed" min="1" max="10" value="5">
                    <div class="range-label"><span>æ…¢</span><span id="speedVal">5</span><span>å¿«</span></div>
                </div>
                <div class="form-group" id="horizontalPosGroup" style="display: none;">
                    <label>å‚ç›´ä½ç½®</label>
                    <div class="radio-group">
                        <label><input type="radio" name="horizontalPosition" value="top"> é ‚éƒ¨</label>
                        <label><input type="radio" name="horizontalPosition" value="middle" checked> ä¸­é–“</label>
                        <label><input type="radio" name="horizontalPosition" value="bottom"> åº•éƒ¨</label>
                    </div>
                </div>
                <div class="form-group" id="horizontalLoopStartGroup" style="display: none;">
                    <label>åˆå§‹ä½ç½®</label>
                    <div class="radio-group">
                        <label><input type="radio" name="horizontalLoopStart" value="left" checked> å·¦å´</label>
                        <label><input type="radio" name="horizontalLoopStart" value="right"> å³å´</label>
                    </div>
                </div>
                <div class="form-group" id="verticalPosGroup" style="display: none;">
                    <label>æ°´å¹³ä½ç½®</label>
                    <div class="radio-group">
                        <label><input type="radio" name="verticalPosition" value="left"> å·¦å´</label>
                        <label><input type="radio" name="verticalPosition" value="center" checked> ä¸­é–“</label>
                        <label><input type="radio" name="verticalPosition" value="right"> å³å´</label>
                    </div>
                </div>
                <div class="form-group" id="verticalLoopStartGroup" style="display: none;">
                    <label>åˆå§‹ä½ç½®</label>
                    <div class="radio-group">
                        <label><input type="radio" name="verticalLoopStart" value="top" checked> é ‚éƒ¨</label>
                        <label><input type="radio" name="verticalLoopStart" value="bottom"> åº•éƒ¨</label>
                    </div>
                </div>
                <div class="form-group" id="circleRadiusGroup" style="display: none;">
                    <label>åœ“å‘¨åŠå¾‘ (px)</label>
                    <input type="range" id="circleRadius" min="50" max="400" value="200">
                    <div class="range-label"><span>50</span><span id="circleRadiusVal">200</span><span>400</span></div>
                </div>
                <div class="form-group" id="circleCenterGroup" style="display: none;">
                    <label>æ—‹è½‰ä¸­å¿ƒ</label>
                    <div class="radio-group">
                        <label><input type="radio" name="circleCenter" value="fixed" checked> å›ºå®šä¸­å¿ƒ</label>
                        <label><input type="radio" name="circleCenter" value="random"> éš¨æ©Ÿç§»å‹•</label>
                    </div>
                </div>
                <div class="form-group" id="stayDurationGroup" style="display: none;">
                    <label>åœç•™æ™‚é–“ (ç§’)</label>
                    <input type="range" id="stayDuration" min="0" max="5" step="0.5" value="1">
                    <div class="range-label"><span>0</span><span id="stayVal">1</span><span>5</span></div>
                </div>
                <div class="form-group checkbox-group" id="fadeGroup">
                    <input type="checkbox" id="fade">
                    <label for="fade" style="margin: 0;">æ·¡å…¥æ·¡å‡º</label>
                </div>
            </div>
        </div>

        <!-- åœ–ç‰‡è®Šæ› -->
        <div class="section">
            <h2>åœ–ç‰‡è®Šæ›</h2>
            <div class="content">
                <div class="form-group">
                    <label>ç¿»è½‰</label>
                    <div class="radio-group">
                        <label><input type="radio" name="flip" value="none" checked> ç„¡</label>
                        <label><input type="radio" name="flip" value="horizontal"> æ°´å¹³</label>
                        <label><input type="radio" name="flip" value="vertical"> å‚ç›´</label>
                        <label><input type="radio" name="flip" value="both"> å…©è€…</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¦–è¦ºç‰¹æ•ˆ -->
        <div class="section">
            <h2>è¦–è¦ºç‰¹æ•ˆ (å¯å¤šé¸ç–ŠåŠ )</h2>
            <div class="content">
                <!-- æ—‹è½‰ -->
                <div class="effect-item" id="effect-rotate">
                    <div class="checkbox-group">
                        <input type="checkbox" id="rotateEnable">
                        <label for="rotateEnable" style="margin: 0; font-weight: bold;">æ—‹è½‰</label>
                    </div>
                    <div class="effect-controls">
                        <div class="form-group">
                            <label>æ¨¡å¼</label>
                            <select id="rotateMode">
                                <option value="clockwise">é †æ™‚é‡</option>
                                <option value="counterclockwise">é€†æ™‚é‡</option>
                                <option value="swing">ä¾†å›æ“ºå‹•</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é€Ÿåº¦</label>
                            <input type="range" id="rotateSpeed" min="1" max="10" value="5">
                            <div class="range-label"><span>æ…¢</span><span id="rotateSpeedVal">5</span><span>å¿«</span></div>
                        </div>
                    </div>
                </div>

                <!-- ç¸®æ”¾è„ˆå‹• -->
                <div class="effect-item" id="effect-scale">
                    <div class="checkbox-group">
                        <input type="checkbox" id="scaleEnable">
                        <label for="scaleEnable" style="margin: 0; font-weight: bold;">ç¸®æ”¾è„ˆå‹•</label>
                    </div>
                    <div class="effect-controls">
                        <div class="form-group">
                            <label>æ¨¡å¼</label>
                            <select id="scaleMode">
                                <option value="pulse">å‘¼å¸æ•ˆæœ</option>
                                <option value="bounce">å½ˆè·³æ•ˆæœ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¹…åº¦</label>
                            <input type="range" id="scaleRange" min="0.5" max="2" step="0.1" value="1.3">
                            <div class="range-label"><span>0.5x</span><span id="scaleRangeVal">1.3x</span><span>2x</span></div>
                        </div>
                    </div>
                </div>

                <!-- æ‰­æ›² -->
                <div class="effect-item" id="effect-skew">
                    <div class="checkbox-group">
                        <input type="checkbox" id="skewEnable">
                        <label for="skewEnable" style="margin: 0; font-weight: bold;">æ‰­æ›²</label>
                    </div>
                    <div class="effect-controls">
                        <div class="form-group">
                            <label>æ–¹å‘</label>
                            <select id="skewDirection">
                                <option value="horizontal">æ°´å¹³æ‹‰ä¼¸</option>
                                <option value="vertical">å‚ç›´æ‹‰ä¼¸</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¼·åº¦ (åº¦)</label>
                            <input type="range" id="skewStrength" min="1" max="30" value="15">
                            <div class="range-label"><span>1Â°</span><span id="skewStrengthVal">15Â°</span><span>30Â°</span></div>
                        </div>
                    </div>
                </div>

                <!-- å‚¾æ–œæ–æ™ƒ -->
                <div class="effect-item" id="effect-tilt">
                    <div class="checkbox-group">
                        <input type="checkbox" id="tiltEnable">
                        <label for="tiltEnable" style="margin: 0; font-weight: bold;">å‚¾æ–œæ–æ™ƒ</label>
                    </div>
                    <div class="effect-controls">
                        <div class="form-group">
                            <label>æ¨¡å¼</label>
                            <select id="tiltMode">
                                <option value="swingLR">å·¦å³æ–æ™ƒ</option>
                                <option value="swingUD">ä¸Šä¸‹æ–æ™ƒ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è§’åº¦ (åº¦)</label>
                            <input type="range" id="tiltAngle" min="1" max="45" value="20">
                            <div class="range-label"><span>1Â°</span><span id="tiltAngleVal">20Â°</span><span>45Â°</span></div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡ç³Š -->
                <div class="effect-item" id="effect-blur">
                    <div class="checkbox-group">
                        <input type="checkbox" id="blurEnable">
                        <label for="blurEnable" style="margin: 0; font-weight: bold;">æ¨¡ç³Š</label>
                    </div>
                    <div class="effect-controls">
                        <div class="form-group">
                            <label>é¡å‹</label>
                            <select id="blurType">
                                <option value="gaussian">é«˜æ–¯æ¨¡ç³Š</option>
                                <option value="motion">å‹•æ…‹æ¨¡ç³Š</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¼·åº¦ (px)</label>
                            <input type="range" id="blurStrength" min="0" max="10" value="5">
                            <div class="range-label"><span>0</span><span id="blurStrengthVal">5</span><span>10</span></div>
                        </div>
                    </div>
                </div>

                <!-- é™°å½±/ç™¼å…‰ -->
                <div class="effect-item" id="effect-shadow">
                    <div class="checkbox-group">
                        <input type="checkbox" id="shadowEnable">
                        <label for="shadowEnable" style="margin: 0; font-weight: bold;">é™°å½±/ç™¼å…‰</label>
                    </div>
                    <div class="effect-controls">
                        <div class="form-group">
                            <label>é¡å‹</label>
                            <select id="shadowType">
                                <option value="drop">æŠ•å½±</option>
                                <option value="glow">ç™¼å…‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é¡è‰²</label>
                            <input type="color" id="shadowColor" value="#000000">
                        </div>
                        <div class="form-group">
                            <label>å¼·åº¦ (px)</label>
                            <input type="range" id="shadowStrength" min="0" max="20" value="10">
                            <div class="range-label"><span>0</span><span id="shadowStrengthVal">10</span><span>20</span></div>
                        </div>
                    </div>
                </div>

                <!-- è‰²ç›¸æ—‹è½‰ -->
                <div class="effect-item" id="effect-hue">
                    <div class="checkbox-group">
                        <input type="checkbox" id="hueEnable">
                        <label for="hueEnable" style="margin: 0; font-weight: bold;">è‰²ç›¸æ—‹è½‰ (å½©è™¹)</label>
                    </div>
                    <div class="effect-controls">
                        <div class="form-group">
                            <label>é€Ÿåº¦</label>
                            <input type="range" id="hueSpeed" min="1" max="10" value="5">
                            <div class="range-label"><span>æ…¢</span><span id="hueSpeedVal">5</span><span>å¿«</span></div>
                        </div>
                    </div>
                </div>

                <!-- 3Dæ—‹è½‰ -->
                <div class="effect-item" id="effect-3d">
                    <div class="checkbox-group">
                        <input type="checkbox" id="rotate3dEnable">
                        <label for="rotate3dEnable" style="margin: 0; font-weight: bold;">3Dæ—‹è½‰</label>
                    </div>
                    <div class="effect-controls">
                        <div class="form-group">
                            <label>è»¸å‘</label>
                            <select id="rotate3dAxis">
                                <option value="x">Xè»¸ (ä¸Šä¸‹ç¿»)</option>
                                <option value="y">Yè»¸ (å·¦å³ç¿»)</option>
                                <option value="z">Zè»¸ (å¹³é¢è½‰)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é€Ÿåº¦</label>
                            <input type="range" id="rotate3dSpeed" min="1" max="10" value="5">
                            <div class="range-label"><span>æ…¢</span><span id="rotate3dSpeedVal">5</span><span>å¿«</span></div>
                        </div>
                    </div>
                </div>

                <!-- æŠ–å‹• -->
                <div class="effect-item" id="effect-shake">
                    <div class="checkbox-group">
                        <input type="checkbox" id="shakeEnable">
                        <label for="shakeEnable" style="margin: 0; font-weight: bold;">æŠ–å‹•</label>
                    </div>
                    <div class="effect-controls">
                        <div class="form-group">
                            <label>å¼·åº¦ (px)</label>
                            <input type="range" id="shakeStrength" min="1" max="10" value="5">
                            <div class="range-label"><span>1</span><span id="shakeStrengthVal">5</span><span>10</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¶ä»–è¨­å®š -->
        <div class="section">
            <h2>å…¶ä»–è¨­å®š</h2>
            <div class="content">
                <div class="form-group">
                    <label>åœ–ç‰‡å¤§å° (%)</label>
                    <input type="range" id="size" min="10" max="200" value="100">
                    <div class="range-label"><span>10%</span><span id="sizeVal">100%</span><span>200%</span></div>
                </div>
                <div class="form-group">
                    <label>é€æ˜åº¦ (%)</label>
                    <input type="range" id="opacity" min="0" max="100" value="100">
                    <div class="range-label"><span>0%</span><span id="opacityVal">100%</span><span>100%</span></div>
                </div>
            </div>
        </div>

        <!-- æŒ‰éˆ• -->
        <div class="buttons">
            <button class="btn btn-secondary" onclick="resetSettings()">é‡ç½®è¨­å®š</button>
            <button class="btn btn-secondary" onclick="exportSettings()">åŒ¯å‡ºè¨­å®š</button>
            <button class="btn btn-secondary" onclick="importSettings()">åŒ¯å…¥è¨­å®š</button>
            <button class="btn btn-primary" onclick="saveAndOpen()">å„²å­˜ä¸¦é–‹å•Ÿçµæœé </button>
        </div>
    </div>

    <script>
        // IndexedDB åˆå§‹åŒ–
        let db;
        let dbReady = false;
        const dbName = 'ImageAnimationDB';
        const storeName = 'config';

        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 1);
            request.onupgradeneeded = function(e) {
                const database = e.target.result;
                if (!database.objectStoreNames.contains(storeName)) {
                    database.createObjectStore(storeName);
                }
            };
            request.onsuccess = function(e) {
                db = e.target.result;
                dbReady = true;
                resolve(db);
            };
            request.onerror = function(e) {
                console.error('IndexedDB error:', e);
                reject(e);
            };
        });

        // å„²å­˜åˆ° IndexedDB
        async function saveToDB(key, value) {
            await dbPromise;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(value, key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // å¾ IndexedDB è®€å–
        async function loadFromDB(key) {
            await dbPromise;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // åˆå§‹åŒ–
        const rangeInputs = ['speed', 'stayDuration', 'circleRadius', 'rotateSpeed', 'scaleRange', 'skewStrength', 'tiltAngle', 'blurStrength', 'shadowStrength', 'hueSpeed', 'rotate3dSpeed', 'shakeStrength', 'size', 'opacity'];
        rangeInputs.forEach(id => {
            const input = document.getElementById(id);
            const display = document.getElementById(id + 'Val');
            input.addEventListener('input', () => {
                let val = input.value;
                if (id === 'scaleRange') val += 'x';
                else if (id === 'skewStrength' || id === 'tiltAngle') val += 'Â°';
                else if (id === 'blurStrength' || id === 'shadowStrength' || id === 'shakeStrength' || id === 'circleRadius') val += 'px';
                else if (id === 'size' || id === 'opacity') val += '%';
                display.textContent = val;
            });
        });

        // ç‰¹æ•ˆé–‹é—œ
        ['rotate', 'scale', 'skew', 'tilt', 'blur', 'shadow', 'hue', '3d', 'shake'].forEach(name => {
            const checkbox = document.getElementById(name === '3d' ? 'rotate3dEnable' : name + 'Enable');
            const item = document.getElementById('effect-' + name);
            checkbox.addEventListener('change', () => {
                item.classList.toggle('enabled', checkbox.checked);
            });
        });

        // ç§»å‹•æ¨¡å¼é¸æ“‡é¡¯ç¤ºå°æ‡‰ä½ç½®è¨­å®š
        const moveMode = document.getElementById('moveMode');
        const horizontalPosGroup = document.getElementById('horizontalPosGroup');
        const verticalPosGroup = document.getElementById('verticalPosGroup');

        const horizontalLoopStartGroup = document.getElementById('horizontalLoopStartGroup');
        const verticalLoopStartGroup = document.getElementById('verticalLoopStartGroup');
        const circleRadiusGroup = document.getElementById('circleRadiusGroup');
        const circleCenterGroup = document.getElementById('circleCenterGroup');
        const stayDurationGroup = document.getElementById('stayDurationGroup');
        const fadeGroup = document.getElementById('fadeGroup');

        function updatePositionVisibility() {
            const mode = moveMode.value;
            const horizontalModes = ['leftToRight', 'rightToLeft'];
            const verticalModes = ['topToBottom', 'bottomToTop'];
            const stayModes = ['randomAppear', 'horizontalLoop', 'verticalLoop'];

            horizontalPosGroup.style.display = (horizontalModes.includes(mode) || mode === 'horizontalLoop') ? 'block' : 'none';
            verticalPosGroup.style.display = (verticalModes.includes(mode) || mode === 'verticalLoop') ? 'block' : 'none';
            horizontalLoopStartGroup.style.display = mode === 'horizontalLoop' ? 'block' : 'none';
            verticalLoopStartGroup.style.display = mode === 'verticalLoop' ? 'block' : 'none';
            circleRadiusGroup.style.display = mode === 'circle' ? 'block' : 'none';
            circleCenterGroup.style.display = mode === 'circle' ? 'block' : 'none';
            stayDurationGroup.style.display = stayModes.includes(mode) ? 'block' : 'none';
            fadeGroup.style.display = mode !== 'static' ? 'block' : 'none';
        }

        moveMode.addEventListener('change', updatePositionVisibility);
        updatePositionVisibility();

        // è¼‰å…¥ä¸Šæ¬¡è¨­å®š
        async function loadLastConfig() {
            try {
                const config = await loadFromDB('imageAnimationConfig');
                if (!config) return;

                // è¼‰å…¥åœ–ç‰‡
                if (config.image) {
                    const preview = document.getElementById('preview');
                    preview.innerHTML = `<img src="${config.image}" alt="preview">`;
                }

                // è¼‰å…¥ç§»å‹•è¨­å®š
                if (config.movement) {
                    document.getElementById('moveMode').value = config.movement.mode || 'static';
                    document.getElementById('speed').value = config.movement.speed || 5;
                    document.getElementById('speed').dispatchEvent(new Event('input'));
                    document.getElementById('stayDuration').value = config.movement.stayDuration || 1;
                    document.getElementById('stayDuration').dispatchEvent(new Event('input'));
                    document.getElementById('fade').checked = config.movement.fade || false;

                    if (config.movement.horizontalPosition) {
                        document.querySelector(`input[name="horizontalPosition"][value="${config.movement.horizontalPosition}"]`).checked = true;
                    }
                    if (config.movement.verticalPosition) {
                        document.querySelector(`input[name="verticalPosition"][value="${config.movement.verticalPosition}"]`).checked = true;
                    }
                    if (config.movement.horizontalLoopStart) {
                        document.querySelector(`input[name="horizontalLoopStart"][value="${config.movement.horizontalLoopStart}"]`).checked = true;
                    }
                    if (config.movement.verticalLoopStart) {
                        document.querySelector(`input[name="verticalLoopStart"][value="${config.movement.verticalLoopStart}"]`).checked = true;
                    }
                    if (config.movement.circleRadius) {
                        document.getElementById('circleRadius').value = config.movement.circleRadius;
                        document.getElementById('circleRadius').dispatchEvent(new Event('input'));
                    }
                    if (config.movement.circleCenter) {
                        document.querySelector(`input[name="circleCenter"][value="${config.movement.circleCenter}"]`).checked = true;
                    }

                    updatePositionVisibility();
                }

                // è¼‰å…¥ç¿»è½‰è¨­å®š
                if (config.flip) {
                    document.querySelector(`input[name="flip"][value="${config.flip}"]`).checked = true;
                }

                // è¼‰å…¥ç‰¹æ•ˆè¨­å®š
                if (config.effects) {
                    // æ—‹è½‰
                    if (config.effects.rotate) {
                        document.getElementById('rotateEnable').checked = config.effects.rotate.enabled;
                        document.getElementById('rotateEnable').dispatchEvent(new Event('change'));
                        document.getElementById('rotateMode').value = config.effects.rotate.mode;
                        document.getElementById('rotateSpeed').value = config.effects.rotate.speed;
                        document.getElementById('rotateSpeed').dispatchEvent(new Event('input'));
                    }
                    // ç¸®æ”¾
                    if (config.effects.scale) {
                        document.getElementById('scaleEnable').checked = config.effects.scale.enabled;
                        document.getElementById('scaleEnable').dispatchEvent(new Event('change'));
                        document.getElementById('scaleMode').value = config.effects.scale.mode;
                        document.getElementById('scaleRange').value = config.effects.scale.range;
                        document.getElementById('scaleRange').dispatchEvent(new Event('input'));
                    }
                    // æ‰­æ›²
                    if (config.effects.skew) {
                        document.getElementById('skewEnable').checked = config.effects.skew.enabled;
                        document.getElementById('skewEnable').dispatchEvent(new Event('change'));
                        document.getElementById('skewDirection').value = config.effects.skew.direction;
                        document.getElementById('skewStrength').value = config.effects.skew.strength;
                        document.getElementById('skewStrength').dispatchEvent(new Event('input'));
                    }
                    // å‚¾æ–œ
                    if (config.effects.tilt) {
                        document.getElementById('tiltEnable').checked = config.effects.tilt.enabled;
                        document.getElementById('tiltEnable').dispatchEvent(new Event('change'));
                        document.getElementById('tiltMode').value = config.effects.tilt.mode;
                        document.getElementById('tiltAngle').value = config.effects.tilt.angle;
                        document.getElementById('tiltAngle').dispatchEvent(new Event('input'));
                    }
                    // æ¨¡ç³Š
                    if (config.effects.blur) {
                        document.getElementById('blurEnable').checked = config.effects.blur.enabled;
                        document.getElementById('blurEnable').dispatchEvent(new Event('change'));
                        document.getElementById('blurType').value = config.effects.blur.type;
                        document.getElementById('blurStrength').value = config.effects.blur.strength;
                        document.getElementById('blurStrength').dispatchEvent(new Event('input'));
                    }
                    // é™°å½±
                    if (config.effects.shadow) {
                        document.getElementById('shadowEnable').checked = config.effects.shadow.enabled;
                        document.getElementById('shadowEnable').dispatchEvent(new Event('change'));
                        document.getElementById('shadowType').value = config.effects.shadow.type;
                        document.getElementById('shadowColor').value = config.effects.shadow.color;
                        document.getElementById('shadowStrength').value = config.effects.shadow.strength;
                        document.getElementById('shadowStrength').dispatchEvent(new Event('input'));
                    }
                    // è‰²ç›¸æ—‹è½‰
                    if (config.effects.hueRotate) {
                        document.getElementById('hueEnable').checked = config.effects.hueRotate.enabled;
                        document.getElementById('hueEnable').dispatchEvent(new Event('change'));
                        document.getElementById('hueSpeed').value = config.effects.hueRotate.speed;
                        document.getElementById('hueSpeed').dispatchEvent(new Event('input'));
                    }
                    // 3Dæ—‹è½‰
                    if (config.effects.rotate3d) {
                        document.getElementById('rotate3dEnable').checked = config.effects.rotate3d.enabled;
                        document.getElementById('rotate3dEnable').dispatchEvent(new Event('change'));
                        document.getElementById('rotate3dAxis').value = config.effects.rotate3d.axis;
                        document.getElementById('rotate3dSpeed').value = config.effects.rotate3d.speed;
                        document.getElementById('rotate3dSpeed').dispatchEvent(new Event('input'));
                    }
                    // æŠ–å‹•
                    if (config.effects.shake) {
                        document.getElementById('shakeEnable').checked = config.effects.shake.enabled;
                        document.getElementById('shakeEnable').dispatchEvent(new Event('change'));
                        document.getElementById('shakeStrength').value = config.effects.shake.strength;
                        document.getElementById('shakeStrength').dispatchEvent(new Event('input'));
                    }
                }

                // è¼‰å…¥å…¶ä»–è¨­å®š
                if (config.size) {
                    document.getElementById('size').value = config.size;
                    document.getElementById('size').dispatchEvent(new Event('input'));
                }
                if (config.opacity !== undefined) {
                    document.getElementById('opacity').value = config.opacity;
                    document.getElementById('opacity').dispatchEvent(new Event('input'));
                }
            } catch (err) {
                console.log('ç„¡ä¸Šæ¬¡è¨­å®šæˆ–è¼‰å…¥å¤±æ•—');
            }
        }

        // é é¢è¼‰å…¥æ™‚è®€å–è¨­å®š
        dbPromise.then(() => loadLastConfig());

        // åœ–ç‰‡ä¸Šå‚³
        document.getElementById('imageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 50 * 1024 * 1024) {
                alert('æª”æ¡ˆéå¤§ï¼å»ºè­° < 50MBï¼Œéå¤§å¯èƒ½å½±éŸ¿æ•ˆèƒ½');
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('preview');
                preview.innerHTML = `<img src="${event.target.result}" alt="preview">`;
            };
            reader.readAsDataURL(file);
        });

        // æ‘ºç–ŠåŠŸèƒ½
        document.querySelectorAll('.section h2').forEach(h2 => {
            h2.addEventListener('click', () => {
                h2.parentElement.classList.toggle('collapsed');
            });
        });

        // å„²å­˜ä¸¦é–‹å•Ÿ
        async function saveAndOpen() {
            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸Šå‚³æ–°åœ–ç‰‡æˆ–å·²è¼‰å…¥çš„åœ–ç‰‡
            const imageFile = document.getElementById('imageFile').files[0];
            const hasLoadedImage = document.querySelector('#preview img');

            if (!imageFile && !hasLoadedImage) {
                alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼');
                return;
            }

            // å¦‚æœæœ‰ä¸Šå‚³æ–°åœ–ç‰‡,ä½¿ç”¨æ–°åœ–ç‰‡
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    await saveConfig(event.target.result);
                };
                reader.readAsDataURL(imageFile);
            } else {
                // ä½¿ç”¨å·²è¼‰å…¥çš„åœ–ç‰‡
                const currentImage = hasLoadedImage.src;
                await saveConfig(currentImage);
            }
        }

        // å„²å­˜è¨­å®šå‡½å¼
        async function saveConfig(imageData) {
                const config = {
                    image: imageData,
                    movement: {
                        mode: document.getElementById('moveMode').value,
                        speed: parseInt(document.getElementById('speed').value),
                        stayDuration: parseFloat(document.getElementById('stayDuration').value),
                        fade: document.getElementById('fade').checked,
                        horizontalPosition: document.querySelector('input[name="horizontalPosition"]:checked').value,
                        verticalPosition: document.querySelector('input[name="verticalPosition"]:checked').value,
                        horizontalLoopStart: document.querySelector('input[name="horizontalLoopStart"]:checked')?.value || 'left',
                        verticalLoopStart: document.querySelector('input[name="verticalLoopStart"]:checked')?.value || 'top',
                        circleRadius: parseInt(document.getElementById('circleRadius').value),
                        circleCenter: document.querySelector('input[name="circleCenter"]:checked')?.value || 'fixed'
                    },
                    flip: document.querySelector('input[name="flip"]:checked').value,
                    effects: {
                        rotate: {
                            enabled: document.getElementById('rotateEnable').checked,
                            mode: document.getElementById('rotateMode').value,
                            speed: parseInt(document.getElementById('rotateSpeed').value)
                        },
                        scale: {
                            enabled: document.getElementById('scaleEnable').checked,
                            mode: document.getElementById('scaleMode').value,
                            range: parseFloat(document.getElementById('scaleRange').value)
                        },
                        skew: {
                            enabled: document.getElementById('skewEnable').checked,
                            direction: document.getElementById('skewDirection').value,
                            strength: parseInt(document.getElementById('skewStrength').value)
                        },
                        tilt: {
                            enabled: document.getElementById('tiltEnable').checked,
                            mode: document.getElementById('tiltMode').value,
                            angle: parseInt(document.getElementById('tiltAngle').value)
                        },
                        blur: {
                            enabled: document.getElementById('blurEnable').checked,
                            type: document.getElementById('blurType').value,
                            strength: parseInt(document.getElementById('blurStrength').value)
                        },
                        shadow: {
                            enabled: document.getElementById('shadowEnable').checked,
                            type: document.getElementById('shadowType').value,
                            color: document.getElementById('shadowColor').value,
                            strength: parseInt(document.getElementById('shadowStrength').value)
                        },
                        hueRotate: {
                            enabled: document.getElementById('hueEnable').checked,
                            speed: parseInt(document.getElementById('hueSpeed').value)
                        },
                        rotate3d: {
                            enabled: document.getElementById('rotate3dEnable').checked,
                            axis: document.getElementById('rotate3dAxis').value,
                            speed: parseInt(document.getElementById('rotate3dSpeed').value)
                        },
                        shake: {
                            enabled: document.getElementById('shakeEnable').checked,
                            strength: parseInt(document.getElementById('shakeStrength').value)
                        }
                    },
                    size: parseInt(document.getElementById('size').value),
                    opacity: parseInt(document.getElementById('opacity').value)
                };

                try {
                    await saveToDB('imageAnimationConfig', config);
                    window.open('result.html', '_blank');
                } catch (err) {
                    console.error('å„²å­˜å¤±æ•—:', err);
                    alert('å„²å­˜å¤±æ•—ï¼š' + err.message);
                }
        }

        // é‡ç½®è¨­å®š
        async function resetSettings() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¨­å®šï¼Ÿ')) {
                try {
                    // æ¸…é™¤ IndexedDB è³‡æ–™
                    await dbPromise;
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    await store.delete('imageAnimationConfig');

                    // é‡æ–°è¼‰å…¥é é¢
                    location.reload();
                } catch (err) {
                    console.error('é‡ç½®å¤±æ•—:', err);
                    location.reload();
                }
            }
        }

        // åŒ¯å‡ºè¨­å®š
        async function exportSettings() {
            try {
                const config = await loadFromDB('imageAnimationConfig');
                if (!config) {
                    alert('å°šç„¡è¨­å®šå¯åŒ¯å‡ºï¼');
                    return;
                }
                const blob = new Blob([JSON.stringify(config)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'animation-config.json';
                a.click();
            } catch (err) {
                alert('åŒ¯å‡ºå¤±æ•—ï¼š' + err.message);
            }
        }

        // åŒ¯å…¥è¨­å®š
        async function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = async event => {
                    try {
                        const config = JSON.parse(event.target.result);
                        await saveToDB('imageAnimationConfig', config);
                        alert('åŒ¯å…¥æˆåŠŸï¼è«‹é‡æ–°æ•´ç†é é¢ä»¥å¥—ç”¨è¨­å®šã€‚');
                    } catch (err) {
                        alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // é è¨­ç¯„æœ¬
        function loadTemplate(type) {
            const templates = {
                pet: {
                    moveMode: 'randomBounce',
                    speed: 3,
                    fade: false,
                    effects: {}
                },
                float: {
                    moveMode: 'verticalLoop',
                    speed: 2,
                    fade: true,
                    effects: {}
                },
                neon: {
                    moveMode: 'static',
                    speed: 5,
                    fade: false,
                    effects: {
                        hueEnable: true,
                        hueSpeed: 5,
                        shadowEnable: true,
                        shadowType: 'glow',
                        shadowColor: '#00ffff',
                        shadowStrength: 15
                    }
                },
                roll: {
                    moveMode: 'leftToRight',
                    speed: 5,
                    fade: false,
                    effects: {
                        rotateEnable: true,
                        rotateMode: 'clockwise',
                        rotateSpeed: 5
                    }
                },
                randomPop: {
                    moveMode: 'randomAppear',
                    speed: 3,
                    stayDuration: 2,
                    fade: true,
                    effects: {}
                }
            };

            const t = templates[type];
            document.getElementById('moveMode').value = t.moveMode;
            document.getElementById('speed').value = t.speed;
            document.getElementById('speed').dispatchEvent(new Event('input'));
            document.getElementById('fade').checked = t.fade;

            // åœç•™æ™‚é–“
            if (t.stayDuration !== undefined) {
                document.getElementById('stayDuration').value = t.stayDuration;
                document.getElementById('stayDuration').dispatchEvent(new Event('input'));
            }

            // ç¿»è½‰
            const flipValue = t.flip || 'none';
            document.querySelector(`input[name="flip"][value="${flipValue}"]`).checked = true;

            // é‡ç½®æ‰€æœ‰ç‰¹æ•ˆ
            ['rotateEnable', 'scaleEnable', 'skewEnable', 'tiltEnable', 'blurEnable', 'shadowEnable', 'hueEnable', 'rotate3dEnable', 'shakeEnable'].forEach(id => {
                document.getElementById(id).checked = false;
                document.getElementById(id).dispatchEvent(new Event('change'));
            });

            // å¥—ç”¨ç¯„æœ¬ç‰¹æ•ˆ
            if (t.effects) {
                Object.keys(t.effects).forEach(key => {
                    const elem = document.getElementById(key);
                    if (elem) {
                        if (elem.type === 'checkbox') {
                            elem.checked = t.effects[key];
                            elem.dispatchEvent(new Event('change'));
                        } else {
                            elem.value = t.effects[key];
                            if (elem.type === 'range') elem.dispatchEvent(new Event('input'));
                        }
                    }
                });
            }

            alert('ç¯„æœ¬å·²å¥—ç”¨ï¼');
        }
    </script>
</body>
</html>